<html>
<head>
  <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">

<script>
  // Valores de las cadenas de texto
  parrafoInstrucciones= 
    "Selecciona una Unidad Organizativa de la lista. Si no existe, puedes crearla en la consola de administración de tu dominio y pulsar en 'Actualizar' para recargar la lista. Para poder seleccionar una Unidad organizativa, la hoja debe estar rellena con al menos un usuario.";
  loadButton= "Actualizar";
  submitButton= "Seleccionar";
      
  window.onload = function() {
    init();
  };
  
  function init(){
    var leng= window.navigator.language;
    if (leng != "es"){
      google.script.run.withSuccessHandler(translateParrafoInstrucciones).translate(parrafoInstrucciones, leng);
      google.script.run.withSuccessHandler(translateLoadButton).translate(loadButton, leng);
      google.script.run.withSuccessHandler(translateSubmitButton).translate(submitButton, leng);
    }else{
      continueInit();
    }
  }
  
  function continueInit(){
    document.getElementById("parrafoInstrucciones").innerHTML= parrafoInstrucciones;
    document.getElementById("loadButton").value= loadButton;
    document.getElementById("submitButton").value= submitButton;
    document.getElementById("contenido").style.display= "inline";
    cargarCombo();
  }
  
  function translateParrafoInstrucciones(texto){
    parrafoInstrucciones= texto; }
  function translateLoadButton(texto){
    loadButton= texto; }
  function translateSubmitButton(texto){
    submitButton= texto;
    continueInit();
  }
  

  // Devuelve las unidades organizativas del dominio y las pasa a la funcion que las muestra
  function cargarCombo(){
    document.getElementById("msgError").innerHTML= "";
    document.getElementById("imagenCarga").style.display= "inline"; // Imagen de carga
    google.script.run.withSuccessHandler(cargarUO).cargarUO();
  }
  
  // Vacia el combo de opciones
  function vaciarCombo(){
    var combo= document.getElementById("cmb");
    while (combo.options.length > 0){
      combo.remove(0);
    }
  }
  
  // Abre un alert con el estilo propio de Google a partir de un titulo y un mensaje a mostrar
  function customAlert(title, msg){
    google.script.run.withSuccessHandler().confirmation(title, msg);
  }

  // Rellena el combo con las unidades organizativas que recibe por parametros
  function cargarUO(orgUnits){
    document.getElementById("imagenCarga").style.display= "none"; // Oculta la imagen de carga
    
    if (orgUnits == null){ // Si las unidades organizativas estan a nulo muestra un mensaje de error
      var error= "Ha ocurrido un error al cargar las unidades organizativas, intentalo de nuevo más tarde."
      document.getElementById("msgError").innerHTML= error;
    }else{ // En caso contrario rellena el combo con las que hubiera
      var combo= document.getElementById("cmb");
      
      vaciarCombo(); // Vacia el combo, por si se ha vuelto a pulsar el boton
      
      for (var i=0; i<orgUnits.length; i++){
        var option = document.createElement("option");
        option.text = orgUnits[i].orgUnitPath;
        option.value = orgUnits[i].orgUnitId;
        combo.add(option);
      }
      
      document.getElementById("submitButton").disabled = false; // Habilita el boton para seleccionar la U.O.
      document.getElementById("submitButton").style.backgroundColor= "#FFFFFF"; // Y le da estilo
    }
  }
  
  // Confirma la seleccion de la unidad organizativa
  function enviar(){
    var combo= document.getElementById("cmb");
    var valorAPasar= combo.options[combo.selectedIndex].text;
    google.script.run.withSuccessHandler(close).UOSelected(valorAPasar); // Cambia el valor de todos los registros
  }
  
  // Cierra el cuadro de dialogo de seleccion de unidad organizativa
  function close(){
    google.script.host.close();
  }
</script>

<style>
  p { text-align: justify; margin-bottom: 50px;}
  form { }
  #imagenCarga {position:absolute; float:right; margin-top:6px; margin-left:10px; width: 15px; display:none; }
  #msgError { position: absolute; float: left; margin-top: -35px; }
</style>
</head>

<body>
<div id="contenido">
  <p id="parrafoInstrucciones"></p>
  
  <div id="msgError" class="error"></div>
  
  <form name="form">
    <div id="cargaDeUO">
        <select id="cmb"> </select>
        <img id="imagenCarga" src="http://i.imgur.com/jB43NZD.gif" />
    </div>
    
    <br>
    
    <input class="action" id="submitButton" style="background-color: #CDCDCD;" type="button" value="" onclick="enviar()" disabled />
    <input id="loadButton" type="button" value="" onclick="cargarCombo()">
    
  </form>
</div>
</body>

</html>
