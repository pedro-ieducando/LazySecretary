<!DOCTYPE html>

  <!-- All script code -->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.9.1/jquery-ui.min.js"></script>
  <script>
    // Valores de las cadenas de texto
    _0= "Selecciona una Unidad Organizativa de la lista. Si no existe, puedes crearla en la consola de administración de tu dominio y pulsar el botón 'Refrescar' para recargar la lista. Para poder seleccionar una Unidad organizativa, la hoja de cálculo debe estar rellena con los datos de, al menos, un usuario.";
    msgError= "Ha ocurrido un error al cargar las unidades organizativas, intentalo de nuevo más tarde.";
    
    btnSubmit= "Seleccionar";
    btnRefresh= "Refrescar";
    btnCancel= "Cancelar";
    btnDone= "Hecho";
      
    window.onload = function() {
      $("#cargaPagina").fadeIn("fast");
      google.script.run.withSuccessHandler(init).getLanguage();
    };
  
    function init(lang){
    
      if (lang != "es"){
        google.script.run.withSuccessHandler(function (texto){_0=texto;}).translate(_0, lang);
        google.script.run.withSuccessHandler(function (texto){msgError=texto;}).translate(msgError, lang);
        google.script.run.withSuccessHandler(function (texto){btnSubmit=texto;}).translate(btnSubmit, lang);
        google.script.run.withSuccessHandler(function (texto){btnRefresh=texto;}).translate(btnRefresh, lang);
        google.script.run.withSuccessHandler(function (texto){btnCancel=texto;}).translate(btnCancel, lang);
        google.script.run.withSuccessHandler(
          function (texto){
            btnDone=texto;
            continueInit();
          }
        ).translate(btnDone, lang);
      }else{
        continueInit();
      }
    }
  
    function continueInit(){
      $("#0").html(_0);
      $("#btnSubmit").html(btnSubmit);
      $("#btnRefresh").attr("value", btnRefresh);
      $("#btnCancel").html(btnCancel);
      
      $("#cargaPagina").fadeOut("fast");
      $("#contenido").fadeIn("fast");
    
      cargarCombo();
    }

    // Devuelve las unidades organizativas del dominio y las pasa a la funcion que las muestra
    function cargarCombo(){
      $("button").attr("disabled", true);
      $("input").attr("disabled", true);
      
      $("#msgError").html("");
      $("#imagenCarga").fadeIn("fast"); // Imagen de carga
      google.script.run.withSuccessHandler(cargarUO).cargarUO();
    }
  
    // Vacía el combo de opciones
    function vaciarCombo(){
      var combo= document.getElementById("cmb");
      while (combo.options.length > 0){
        combo.remove(0);
      }
    }
    
    // Rellena el combo con las unidades organizativas que recibe por parametros
    function cargarUO(orgUnits){
      $("#imagenCarga").fadeOut("fast"); // Oculta la imagen de carga
    
      if (orgUnits == null){ // Si no se han recibido unidades organizativas muestra un mensaje de error
        $("#msgError").html(msgError);
      
      }else{
        vaciarCombo(); // Vacia el combo
        var combo= document.getElementById("cmb");
        
        // Añadimos tantas opciones como unidades organizativas haya
        for (var i=0; i<orgUnits.length; i++){
          var option = document.createElement("option");
          option.text = orgUnits[i].orgUnitPath;
          option.value = orgUnits[i].orgUnitId;
          combo.add(option);
        }
        
        $("button").attr("disabled", false);
        $("input").attr("disabled", false);
      }
    }
  
  
    // Confirma la seleccion de la unidad organizativa
    function enviar(){
      $("button").attr("disabled", true);
      $("input").attr("disabled", true);
      
      var combo= document.getElementById("cmb");
      var valorAPasar= combo.options[combo.selectedIndex].text;
      
      google.script.run.withSuccessHandler(finish).UOSelected(valorAPasar); // Cambia el valor de todos los registros
    }
  
  
    // Cierra el cuadro de dialogo de seleccion de unidad organizativa
    function finish(){
      $("button").attr("disabled", false);
      $("input").attr("disabled", false);
      $("#btnCancel").html(btnDone);
    }
  
    // Cierra el cuadro de diálogo
    function cerrar(){
      google.script.host.close();
    }
    
    // End-script
  </script>


<!-- All style code -->
<link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
<style>
  p { text-align: justify; margin-bottom: 50px;}
  #cmb { max-width: 550px; min-width: 225px; }
  #contenido {display:none; text-align: justify;}
  #imagenCarga {position:absolute; float:right; margin-top:6px; margin-left:10px; width: 15px; display:none; }
  #msgError { position: absolute; float: left; margin-top: -35px; }
  #cargaPagina { top: 40%; left:50%; position: absolute; display: none;}
  #actions { bottom: 0px; position: absolute; }
</style>


<!-- All html code -->
<div id="cargaPagina">
    <img src="http://i.imgur.com/jB43NZD.gif" />
</div>
  
<div id="contenido">
  <p id="0"></p>
  
  <div id="msgError" class="error"></div>
  
  <form name="form">
    <div id="cargaDeUO">
        <select id="cmb"> </select>
        <img id="imagenCarga" src="http://i.imgur.com/jB43NZD.gif" />
    </div>
    
    <br>
    
    <div id="actions">
      <button id="btnSubmit" class="action" onclick="enviar()" disabled ></button>
      
      <!-- Si utilizamos la etiqueta button con este, da problemas -->
      <input type="button" id="btnRefresh" onclick="cargarCombo()" disabled/> 
      
      <button id="btnCancel" onclick="cerrar()" disabled></button>
    </div>
  </form>
</div>
